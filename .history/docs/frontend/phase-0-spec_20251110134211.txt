# 0. New Files Overview

| File | Purpose |
| --- | --- |
| `package.json` | Root workspace config enabling npm workspaces and delegating scripts to `apps/web`. |
| `apps/web/package.json` | Next.js app manifest with scripts (`dev`, `build`, `lint`, `typecheck`) and runtime/dev dependencies (Next 14 App Router, React, Tailwind, Framer Motion, lucide-react). |
| `apps/web/.eslintrc.json` | ESLint configuration extending Next.js core-web-vitals rules for the app. |
| `apps/web/jsconfig.json` | Configures absolute imports via `@/*` path alias. |
| `apps/web/tsconfig.json` | TypeScript compiler options (strict mode, React Compiler plugin, path aliases). |
| `apps/web/next-env.d.ts` | Next.js-managed TypeScript environment declarations. |
| `apps/web/next.config.mjs` | Next.js configuration enabling React Compiler and lint directory scoping. |
| `apps/web/postcss.config.mjs` | PostCSS pipeline referencing Tailwind and Autoprefixer. |
| `apps/web/tailwind.config.ts` | Tailwind theme customization (color tokens, fonts, container sizing, animate plugin). |
| `apps/web/public/icons/favicon.svg` | Base favicon matching Tithi branding for marketing surface. |
| `apps/web/src/app/globals.css` | Global styles: Tailwind layers, background gradients, glass effects, typography defaults. |
| `apps/web/src/styles/fonts.ts` | Loads Plus Jakarta Sans and Space Grotesk with CSS variables. |
| `apps/web/src/lib/utils.ts` | Utility helper (`cn`) merging className variants. |
| `apps/web/src/hooks/use-session.ts` | Placeholder hook returning mock unauthenticated session to unblock UI wiring. |
| `apps/web/src/config/stripe.ts` | Stripe placeholder config to prep for future integration and mock API usage. |
| `apps/web/src/app/api/stripe/config/route.ts` | Stub API route exposing placeholder Stripe config for frontend consumption. |
| `apps/web/src/data/landing.ts` | Static content for landing hero CTA text/links. |
| `apps/web/src/components/ui/button.tsx` | Reusable button component using Radix Slot + CVA for primary/outline variants. |
| `apps/web/src/components/landing/hero.tsx` | Landing page hero section with animated headline, CTA buttons, and background glow. |
| `apps/web/src/app/layout.tsx` | Root layout applying fonts, metadata, and global structure. |
| `apps/web/src/app/page.tsx` | Landing page entry rendering `LandingHero`. |
| `docs/frontend/phase-0-spec.txt` | This system/product spec describing Phase 0 deliverables and architecture intent. |

# 1. Vision & Value Proposition

Tithi is a multi-tenant, white-label booking and payments SaaS for service businesses (salons, clinics, studios). Each tenant (business) is isolated, branded, and billed separately. The current build (Phase 0) delivers the frontend scaffold and production-quality landing page that mirrors the Figma direction in `frontend logistics.txt`. Success for tenant owners means:
- Fast onboarding to configure business data, payments, policies, and notifications.
- Complete control over booking lifecycle, including manual capture, policy-driven fees, and gift cards.
- Stripe-ready infrastructure that respects manual charge rules and platform fee capture.

Success for customers (bookers) means:
- Seamless discovery of services, staff availability, and transparent policies.
- Checkout that stores a card securely (no immediate charge) with clear post-booking expectations.
- Consistent notifications across email/SMS with accurate placeholders.

Non-goals for MVP:
- Staff logins/permissions beyond scheduling context.
- Marketplace aggregation across tenants.
- Instant charge at booking, deposits beyond defined flows, or complex resource management (rooms, equipment).

# 2. Personas & Surfaces

| Persona | Description | Primary Goals | Surfaces |
| --- | --- | --- | --- |
| Tenant Owner (Admin) | Business owner who configures tenant data and manages bookings/payments. | Configure catalog, policies, availability; capture/no-show/cancel/refund payments; monitor subscription state. | Owner Admin App (`tithi.com/app`, `tithi.com/app/b/{businessId}`) |
| Customer (Booker) | End user booking an appointment via branded tenant site. | Discover services, pick staff/time, provide details, authorize card, manage gift codes. | Public Booking Site (`https://{subdomain}.tithi.com`) |

Surfaces:
1. Landing (`tithi.com`): marketing hero, call to action (Get Started, Sign In).
2. Owner Admin App (future phases): dashboard, onboarding mirror, money board, account/subscription controls.
3. Public Booking Site (future phases): tenant-branded flows, widget support.

# 3. Core User Journeys (Narrative + Steps)

## 3.1 Onboarding (8 steps)

| Step | Inputs | Validations | Outputs/Persistence |
| --- | --- | --- | --- |
| 1. Business Basics | Business name, description, DBA, legal name, industry. | Required fields, max lengths, industry selection. | Tenant record seeded with identity metadata. |
| 2. Booking Website | Subdomain slug. | Regex `[a-z0-9-]{3,63}`, uniqueness, reserved-word check. | Tenant slug reserved, DNS provisioning queued. |
| 3. Location & Contacts | Timezone, phone, support email, website, address. | Timezone valid Olson ID; phone E.164; email RFC-ish; address length. | Tenant contact bundle stored; drives booking header + notifications. |
| 4. Team (Scheduling only) | Staff name, role, color code. | Name required; role optional; color hex validated; no login. | Staff entries created for availability mapping. |
| 5. Branding | Logo upload, primary color. | File type/size; color hex. | Branding assets stored (S3) with references on tenant config. |
| 6. Services & Categories | Category: name, description, color. Service: name, description, duration, price, pre-appointment notes. | Non-empty names; duration in minutes; price cents ≥ 0; color hex. | Categories + services persisted; services reference category + tenant. |
| 7. Availability | For each service, assign staff and schedules. | Ensure staff-service mapping exists; schedules non-overlapping; timezone aware; buffers considered. | Availability rules saved; slot generator caches invalidated. |
| 8. Notifications | Template name, channel, category, subject (email), trigger, body with placeholders. | Placeholder linting; length; enable/disable toggle. | Notification templates versioned with placeholder whitelist. |

Post-step: Policies + Confirmation (cancellation, no-show fee/%, refund, cash policy), Gift Cards (optional definitions), Payment Setup (Stripe Connect onboarding + subscription), Go Live (subdomain accessible).

## 3.2 Public Booking Flow

1. Discover (catalog): Business header (name, description, address), categories, services with price/duration/notes.
2. Select service → choose staff (optional) → view availability slots (color-coded by staff, service-duration sized, respects buffers, timezone).
3. Checkout: Form collects customer name/email/phone, gift card code (optional), shows policies modal (must consent). Stripe Payment Element stores card via SetupIntent (no charge). Booking saved as `pending`/`authorized`.
4. Confirmation: Display service/time/price/policies; notify via configured channels (booking received).

## 3.3 Admin “Money Board”

For each booking block (customer + service + amounts + status chip):
- **Completed**: Capture full booking amount via Stripe PaymentIntent (manual capture). Update status `captured`. #1% platform fee.
- **No-Show**: Charge configured no-show fee (flat/percent). If fee=0, mark no-show without charge.
- **Cancelled**: Charge cancellation fee per policy; 0 fee => status only.
- **Refund**: If charge exists, issue full/partial refund; update ledger. If no charge yet, button disabled with tooltip "No payment to refund."

All actions idempotent via `X-Idempotency-Key`. Buttons disable with spinner; error states show "Send Pay Link" when customer action required (SCA).

## 3.4 Subscription Controls

States (per business):
- **Trial (7 days)**: Subdomain active; auto-transitions to Active unless paused/canceled.
- **Active**: $11.99/month billed; subdomain live.
- **Paused**: Billing suspended; subdomain optionally up but labeled "Paused".
- **Canceled**: Billing stops; subdomain deprovisioned, tenant archived pending data retention.

Controls: Start Trial, Activate, Pause, Cancel. Show next bill date, current state badge.

# 4. Business Logic Keys (Authoritative Rules)

- Booking checkout stores card via Stripe SetupIntent; no funds captured until admin action.
- Manual capture occurs when owner triggers Completed; no-show/cancel charges use new PaymentIntents with saved payment method; refunds attach to captured charge.
- Platform fee: 1% of captured amount via `application_fee_amount`. Stripe fees deducted normally.
- Gift Cards: amount or percent. Amount-type balance deducted upon charge (not authorization); ledger records delta; optional refund restores balance.
- Notifications: Templates per tenant with placeholders `${customer.name}`, `${service.name}`, `${service.duration}`, `${service.price}`, `${booking.date}`, `${booking.time}`, `${business.name}`, `${booking.url}`. Triggers include Booking Created/Confirmed/24h/1h/Cancelled/Rescheduled/Completed/No-show fee charged/Refunded/Payment issue. Preview uses mock data to validate placeholders.
- Policies: Modal at checkout describing cancellation/no-show/refund/cash policy. Consent requires checkbox; backend stores policy hash, timestamp, IP, user-agent per booking for evidence.

# 5. Routing Map (Frontend)

| Route | Surface | Purpose | Journey Reference |
| --- | --- | --- | --- |
| `tithi.com/` | Landing | CTA to signup/login. | Entry before Onboarding (§3.1) |
| `tithi.com/login`, `/signup` | Marketing/Auth | Owner authentication (future). | Pre-step for onboarding |
| `tithi.com/app` | Owner Admin | Dashboard showing business blocks. | Onboarding review, Money Board (§3.3) |
| `tithi.com/app/b/{businessId}` | Owner Admin | Tenant hub with tabs: Overview, Business, Website, Team, Branding, Services, Availability, Notifications, Policies, Gift Cards, Payment Setup, Account, Past Bookings. | Onboarding mirror, Money Board |
| `https://{subdomain}.tithi.com` | Public Booking | Tenant booking flow. Dev fallback: `/public/{slug}`. | Customer booking (§3.2) |

# 6. Planned API Map (Backend Intent)

| Method | Path | Purpose | Auth/Tenancy | Pagination/Filters | Idempotency |
| --- | --- | --- | --- | --- | --- |
| POST | /v1/auth/signup | Owner signup | Public | — | — |
| POST | /v1/auth/login | Owner login | Public | — | — |
| POST | /v1/auth/refresh | Refresh access token | Public (refresh token) | — | — |
| GET | /v1/tenants/me | Fetch tenant profile | Owner JWT, tenant scope | — | — |
| PATCH | /v1/tenants/me | Update branding/contact | Owner JWT | — | — |
| POST | /v1/tenants/{id}/subscription | Manage subscription states | Owner JWT | — | Required |
| GET | /v1/categories | List categories | Owner JWT | order, status | — |
| POST | /v1/categories | Create category | Owner JWT | — | Required |
| GET | /v1/services | List services | Owner JWT | category_id, active | — |
| POST | /v1/services | Create service | Owner JWT | — | Required |
| PATCH | /v1/services/{id} | Update service | Owner JWT | — | Required |
| GET | /v1/staff | List staff | Owner JWT | active | — |
| POST | /v1/staff | Create staff | Owner JWT | — | Required |
| PUT | /v1/staff/{id}/services | Assign services | Owner JWT | — | Required |
| GET | /v1/availability/rules | Fetch rules | Owner JWT | staff_id, service_id | — |
| POST | /v1/availability/rules | Create rule | Owner JWT | — | Required |
| GET | /v1/availability/slots | Expanded slots | Owner JWT | service_id, staff_id, week | Cacheable |
| GET | /v1/blackouts | List blackouts | Owner JWT | staff_id | — |
| POST | /v1/blackouts | Create blackout | Owner JWT | — | Required |
| GET | /v1/public/tenants/{slug}/catalog | Public catalog | Public, slug | — | Cache |
| GET | /v1/public/tenants/{slug}/availability | Public slots | Public | date, service_id, staff_id | Cache |
| POST | /v1/public/tenants/{slug}/book | Create booking (SetupIntent) | Public | — | Required |
| GET | /v1/bookings | List bookings | Owner JWT | status, date range, staff, search | Cursor |
| GET | /v1/bookings/{code} | Booking detail | Owner JWT | — | — |
| POST | /v1/bookings/{code}/complete | Capture booking | Owner JWT | — | Required |
| POST | /v1/bookings/{code}/no-show | Charge no-show fee | Owner JWT | — | Required |
| POST | /v1/bookings/{code}/cancel | Apply cancel policy | Owner JWT | — | Required |
| POST | /v1/payments/{id}/refund | Issue refund | Owner JWT | — | Required |
| GET | /v1/payments | Payment ledger | Owner JWT | status, date range | Cursor |
| POST | /v1/gift-cards | Issue gift card | Owner JWT | — | Required |
| GET | /v1/gift-cards?code | Balance lookup | Public/Customer | — | — |
| POST | /v1/gift-cards/{id}/void | Void card | Owner JWT | — | Required |
| GET | /v1/notifications/templates | List templates | Owner JWT | channel | — |
| PATCH | /v1/notifications/templates/{key} | Update template | Owner JWT | — | Required |
| POST | /v1/notifications/templates/{key}/preview | Preview template | Owner JWT | placeholder override | — |
| POST | /v1/webhooks/stripe | Stripe webhook intake | HMAC signed | — | Event dedupe |

# 7. Domain Model (High-Level Entities)

| Entity | Fields (subset) | Type | Required? | Constraints | Notes |
| --- | --- | --- | --- | --- | --- |
| Tenants | id (UUID), slug, display_name, timezone, brand colors, logo_url, status, trial_ends_at, stripe_connect_account_id | Various | Yes | slug unique, timezone Olson | `tenant_id` concept owner of dependent tables |
| Users | id, email, password_hash, name, phone, last_login_at | String/Datetime | email/pass required | email unique | Global (non-tenant) |
| UserTenantRoles | user_id, tenant_id, role (`OWNER`,`ADMIN`,`STAFF`,`VIEW_ONLY`) | UUID | Yes | (user_id, tenant_id) unique | Staff role limited to view schedule; no login for staff in MVP |
| Categories | id, tenant_id, name, description, color, order, active | | Yes | name unique per tenant | Tenant-scoped |
| Services | id, tenant_id, category_id, name, description, duration_min, price_cents, instructions, active | | Yes | duration >0; price ≥0 | |
| Staff | id, tenant_id, name, role, color, active | | Yes | Name required | Scheduling only |
| StaffServices | tenant_id, staff_id, service_id | | Yes | Unique composite | Defines who can perform |
| AvailabilityRules | id, tenant_id, staff_id?, service_id?, type (`weekly`,`exception`,`closure`), weekday, start_time, end_time, date | | Yes | Non-overlap per staff/service | |
| Blackouts | id, tenant_id, staff_id?, start_ts, end_ts, reason | | Start/end required | | |
| Customers | id, tenant_id, name, email, phone, stripe_customer_id | | Name/email required | Email unique per tenant? (soft) | |
| Bookings | id, tenant_id, code, status (`pending`,`authorized`,`completed`,`captured`,`no_show`,`canceled`,`refunded`,`disputed`), service_id, staff_id?, start_ts, end_ts, duration_min, customer_id, policy_hash, consent_ip, consent_user_agent | | Yes | code unique per tenant | Stores policy snapshot metadata |
| BookingPayments | id, tenant_id, booking_id, strategy (`manual_capture`,`deposit_card_on_file` future), amount_authorized_cents, amount_captured_cents, no_show_fee_cents, stripe_payment_intent_id, stripe_setup_intent_id, status (`requires_action`,`authorized`,`captured`,`refunded`,`failed`) | | SetupIntent/PI IDs required | |
| GiftCards | id, tenant_id, code, initial_balance_cents, balance_cents, percent_discount?, expires_at, purchaser_customer_id?, recipient_email | | Code unique per tenant | |
| GiftCardLedger | id, tenant_id, gift_card_id, booking_id?, delta_cents, reason, occurred_at | | Yes | Negative for deduction | |
| Notifications | id, tenant_id, template_key, channel (`email`,`sms`,`push` future), category (`confirmation`,`reminder`, etc.), subject, body_markdown, enabled, placeholders | | Yes | Template_key unique per tenant | |
| Subscriptions | id, tenant_id, stripe_customer_id, stripe_subscription_id, plan, status (`trial`,`active`,`paused`,`canceled`), renewal_at | | Yes | | |
| WebhookEvents | id, tenant_id?, provider, event_type, event_id, payload_json, processed_at | | Yes | event_id unique | Tenant nullable for connect events before mapping |
| AuditLog | id, tenant_id, actor_user_id, action, entity, entity_id, diff_json, ip, ua, created_at | | Yes | | |

# 8. State Machines (Mermaid)

## 8.1 Booking Lifecycle

```mermaid
stateDiagram-v2
  [*] --> pending
  pending --> authorized: SetupIntent confirmed / PI authorized
  authorized --> completed: Service fulfilled (admin action)
  completed --> captured: PaymentIntent capture succeeds
  captured --> refunded: Refund issued
  authorized --> no_show: Admin marks no-show
  no_show --> charged_no_show: Off-session PI succeeds
  charged_no_show --> refunded: Refund no-show fee (optional)
  pending --> canceled: Cancel before authorization
  authorized --> canceled: Cancel policy applied
  canceled --> refunded: Refund if prior capture
  authorized --> expired: Authorization window lapsed
  expired --> canceled: Auto-cancel per policy
```

## 8.2 Payment Status

```mermaid
stateDiagram-v2
  [*] --> initiated
  initiated --> requires_action: SCA needed
  initiated --> authorized: SetupIntent/PI confirmed
  authorized --> captured: Admin capture (Completed action)
  captured --> refunded: Refund processed
  authorized --> failed: Payment fails (card declined)
  requires_action --> authorized: Customer completes SCA
  requires_action --> failed: Customer abandons / timeout
```

# 9. Data Movement & Pipelines (Sequence)

A) Public booking with SetupIntent, B) Admin capture with platform fee, C) Webhook reconciliation.

```mermaid
sequenceDiagram
  participant Customer
  participant PublicApp
  participant API
  participant Stripe
  Customer->>PublicApp: Select service/staff/slot
  PublicApp->>API: POST /v1/public/tenants/{slug}/book (customer + slot + PM details)
  API->>Stripe: Create SetupIntent (save card), create Booking (status=pending)
  Stripe-->>API: SetupIntent client_secret
  API-->>PublicApp: { bookingCode, setupIntentSecret }
  PublicApp->>Stripe: Confirm SetupIntent
  Stripe-->>PublicApp: requires_action or succeeded
  PublicApp-->>API: PATCH booking (status=authorized) if succeeded
```

Admin capture & platform fee:

```mermaid
sequenceDiagram
  participant Owner
  participant AdminApp
  participant API
  participant Stripe
  Owner->>AdminApp: Click "Completed" (idempotency key)
  AdminApp->>API: POST /v1/bookings/{code}/complete (X-Idempotency-Key)
  API->>Stripe: Capture PaymentIntent (transfer to Connect, apply 1% fee)
  Stripe-->>API: capture result
  API-->>AdminApp: {status: "captured", receiptUrl}
  API->>Stripe: optional notification send
```

Webhook reconciliation:
- Stripe sends events (payment_intent.succeeded, payment_intent.requires_action, charge.refunded, customer.subscription.updated).
- Webhook handler enqueues job to update booking/payment/subscription state, ensuring idempotency via event_id.

# 10. Security & Tenancy

- Owner-only admin; staff do not authenticate in MVP.
- JWT auth with tenant_id claim drives Postgres RLS: `SET app.tenant_id = '<uuid>'` per request.
- RLS example: `ALTER TABLE bookings ENABLE ROW LEVEL SECURITY; CREATE POLICY tenant_isolation ON bookings USING (tenant_id = current_setting('app.tenant_id')::uuid);`
- PII boundaries: customer name/email/phone stored per tenant; booking exports masked in other tenants.
- Subdomain rules: Reserve identical to restricted list (e.g., "www", "admin", "support"). Enforce wildcard DNS + TLS.

# 11. Validation Rules (Canonical)

| Field | Rule | Example | Error Copy |
| --- | --- | --- | --- |
| Email | Must match RFC 5322-lite | `owner@studio.com` | "Enter a valid email address." |
| Phone | E.164 or local variant per doc (prefer `+15555551234`) | `+12125551234` | "Use an international phone number." |
| Password | ≥8 chars, 1 uppercase, 1 lowercase, 1 digit | `Ready4Tithi` | "Password must be at least 8 characters with mixed case and a number." |
| Subdomain | `[a-z0-9-]{3,63}`, no leading/trailing hyphen, not reserved | `blue-salon` | "Choose a different subdomain—this one is not available." |
| Business name | 2–80 chars | `Moonlight Aesthetics` | "Business name must be between 2 and 80 characters." |
| Category color | Hex `#RRGGBB` | `#4A5FFF` | "Enter a valid hex color code." |
| Duration | Positive integer minutes (15 increments rec.) | `60` | "Duration must be at least 5 minutes." |
| Price | Non-negative cents | `11900` | "Price must be zero or greater." |
| Gift card code | Uppercase alphanum 8–16 | `ABCD-1234` | "Gift card code format is invalid." |
| Policy text | ≤10,000 chars | | "Policy text is too long." |
| Notification placeholders | Must match allowed set | | "Unknown placeholder. Use the available tokens." |

# 12. Error Taxonomy → UX Mapping

| Error Code | When Raised | HTTP | UI Handling |
| --- | --- | --- | --- |
| `invalid_credentials` | Login fail | 401 | Inline error under form |
| `slug_taken` | Subdomain reserved | 409 | Show "subdomain unavailable" message with suggestions |
| `reserved_slug` | Subdomain in reserved list | 400 | Inline error referencing reserved words |
| `requires_action` | Payment requires SCA | 402 | Trigger "Send Pay Link" button, banner on booking card |
| `payment_failed` | Capture/fee charge failed | 402 | Show red banner + retry/Send Pay Link |
| `invalid_gift_code` | Gift card not found/expired | 400 | Inline form error, disable checkout |
| `insufficient_balance` | Gift card lacks funds | 400 | Inline message, keep total unchanged |
| `policy_not_consented` | Customer skipped checkbox | 400 | Modal reminder, highlight checkbox |
| `subscription_paused` | Admin tries to capture while paused? (should allow) | 409 | Tooltip: "Reactivate subscription to process payments." |
| `idempotency_conflict` | Reused key with different payload | 409 | Toast: "Action already submitted." |
| `not_found` | Accessing missing booking/service | 404 | 404 page / toast |

# 13. Performance & Scale Expectations

- Pagination default 25 items (bookings, payments). Cursor-based for bookings by start_ts desc.
- Filters: bookings by status/date/staff/customer search; payments by status/date.
- Availability caching: Redis keyed by `(tenant_id, service_id, staff_id?, week)` with 60s TTL. Invalidate on new booking or availability change.
- Index hints: 
  - `bookings (tenant_id, status, start_ts DESC)`
  - `staff_services (tenant_id, staff_id)`
  - `gift_cards (tenant_id, code)`
  - `availability_rules (tenant_id, staff_id, service_id)`
- Rate limits: public booking endpoints 60 req/min per IP; admin actions 30 req/min per tenant.

# 14. Observability & Audit

- Structured logs per request: `{timestamp, request_id, tenant_id, user_id, route, status, duration_ms}`.
- Money button actions log idempotency key and Stripe IDs.
- Metrics: bookings created, SetupIntent success/fail, PaymentIntent captures, refunds, platform fee total, reminder sends, gift card redemption count, subscription state transitions.
- AuditLog captures before/after diffs for tenant config, service changes, policy updates. Include IP + user agent.

# 15. Data Lifecycle & Exports

- Soft delete for services/staff/bookings (status flags). Hard delete only through retention policy.
- Tenant cancellation: archive tenant data, disable subdomain immediately, schedule purge after retention window (e.g., 90 days) unless compliance requires longer.
- Exports: Owner can download ZIP containing CSV for customers, bookings (with Stripe IDs), policies, gift cards ledger.
- Policy snapshots stored per booking for legal proof; retention matches booking record.

# 16. Seeds & Fixtures

- Seed tenant: `Studio Nova` with slug `novastudio`, timezone `America/New_York`.
- Categories: `Hair`, `Spa`. Services: `Signature Cut` (60min, $120), `Hydra Facial` (75min, $180).
- Staff: `Ava Thompson` (color `#5B64FF`), `Jalen Rivera` (color `#57D0FF`); service assignments accordingly.
- Availability: Weekly rules (Mon-Fri 09:00-17:00) with lunch break 12:00-13:00; exceptions include blackout for holidays.
- Gift cards: `WELCOME120` ($120 fixed), `SELFCARE20` (20%).
- Seed bookings: 
  - Pending/authorized future booking with SetupIntent ID,
  - Completed/captured booking (`stripe_payment_intent_id=pi_123`),
  - No-show with charged fee,
  - Refunded booking.
- Seed notifications: Templates for booking confirmed, 24h reminder, payment receipt.
- Example payload (seed file JSON):
```json
{
  "tenant": { "slug": "novastudio", "display_name": "Studio Nova", "timezone": "America/New_York" },
  "services": [
    { "id": "svc_cut", "name": "Signature Cut", "duration_min": 60, "price_cents": 12000 }
  ],
  "bookings": [
    { "code": "NS-2025-001", "status": "captured", "service_id": "svc_cut", "start_ts": "2025-12-01T14:00:00Z" }
  ]
}
```

# 17. Open Questions & Assumptions

1. **Gift Card Refund Behavior**: Default assumption is balance restored on refund when owner toggles setting; confirm expected UI control location (Policies vs Gift Cards tab).
2. **Availability Buffers**: Doc mentions buffers “later if needed.” Current assumption: support buffer_before/after fields but not exposed in MVP UI. Need confirmation.
3. **Payment Pause Behavior**: When subscription state = Paused, can owner still capture payments? Doc implies site can stay live. Proposed default: allow captures; display warning banner.
4. **Deposits**: Document references deposit flow as future; treat as non-MVP but design BookingPayments table to accommodate `deposit_cents`. Confirm timeline for deposit support.
5. **Customer Self-Service**: No explicit cancellation/reschedule front-end. Assume manual via support; confirm future roadmap.

---

## Appendices

### A. DTO Examples (TypeScript)

```ts
export type BookingStatus =
  | "pending"
  | "authorized"
  | "completed"
  | "captured"
  | "no_show"
  | "canceled"
  | "refunded"
  | "disputed";

export interface Booking {
  id: string;
  code: string;
  tenant_id: string;
  status: BookingStatus;
  service: ServiceSummary;
  staff?: StaffSummary | null;
  customer: CustomerSummary;
  start_ts: string; // ISO8601 UTC
  end_ts: string; // ISO8601 UTC
  duration_min: number;
  policy_hash: string;
  consent_ip: string;
  consent_user_agent: string;
  payments: BookingPayment[];
}

export interface BookingPayment {
  id: string;
  booking_id: string;
  strategy: "manual_capture";
  amount_authorized_cents: number;
  amount_captured_cents: number;
  no_show_fee_cents?: number | null;
  status: "requires_action" | "authorized" | "captured" | "refunded" | "failed";
  stripe_payment_intent_id?: string;
  stripe_setup_intent_id?: string;
  last_error_code?: string | null;
}

export interface Customer {
  id: string;
  tenant_id: string;
  name: string;
  email: string;
  phone?: string | null;
  created_at: string;
}

export interface Service {
  id: string;
  tenant_id: string;
  category_id: string;
  name: string;
  description?: string | null;
  duration_min: number;
  price_cents: number;
  instructions?: string | null;
  color?: string | null;
  active: boolean;
}
```

### B. Sample Requests/Responses

**POST /v1/public/tenants/{slug}/book (success)**
```json
{
  "service_id": "svc_cut",
  "staff_id": "stf_ava",
  "start_ts": "2025-03-10T15:00:00Z",
  "customer": {
    "name": "Jordan Blake",
    "email": "jordan@example.com",
    "phone": "+14155550123"
  },
  "payment_method_id": "pm_card_visa",
  "gift_card_code": "SELFCARE20",
  "policy_hash": "77eab9...",
  "consent": {
    "ip": "203.0.113.5",
    "user_agent": "Mozilla/5.0"
  }
}
```
Success response:
```json
{
  "booking_code": "NOV-2025-1042",
  "status": "authorized",
  "setup_intent_client_secret": "seti_123_secret_abc",
  "requires_action": false
}
```

Requires action response:
```json
{
  "booking_code": "NOV-2025-1043",
  "status": "requires_action",
  "setup_intent_client_secret": "seti_456_secret_def",
  "requires_action": true
}
```

**POST /v1/bookings/{code}/complete**
Request body:
```json
{
  "idempotency_key": "complete-NOV-2025-1042",
  "capture_amount_cents": 12000
}
```
Success:
```json
{
  "status": "captured",
  "captured_amount_cents": 12000,
  "receipt_url": "https://dashboard.stripe.com/payments/pi_123",
  "platform_fee_cents": 120
}
```
Failure requiring pay link:
```json
{
  "error": {
    "code": "requires_action",
    "message": "Customer must complete payment on their device.",
    "next_step": {
      "type": "send_pay_link",
      "url": "https://pay.stripe.com/pm/abc123"
    }
  }
}
```

**GET /v1/public/tenants/{slug}/availability**
Response:
```json
{
  "service_id": "svc_cut",
  "week_start": "2025-03-10",
  "timezone": "America/New_York",
  "slots": [
    {
      "staff_id": "stf_ava",
      "staff_name": "Ava Thompson",
      "staff_color": "#5B64FF",
      "start_ts": "2025-03-10T15:00:00Z",
      "end_ts": "2025-03-10T16:00:00Z",
      "capacity": 1
    },
    {
      "staff_id": "stf_jalen",
      "staff_name": "Jalen Rivera",
      "staff_color": "#57D0FF",
      "start_ts": "2025-03-10T17:00:00Z",
      "end_ts": "2025-03-10T18:00:00Z",
      "capacity": 1
    }
  ]
}
```

### C. Idempotency & Money Buttons

- Admin actions (`complete`, `no-show`, `cancel`, `refund`) require `X-Idempotency-Key` header.
- Key format recommendation: `{action}-{booking_code}-{timestamp}`.
- Backend persists key + payload hash in `booking_actions_idempotency` table; duplicate with same payload returns cached response; mismatched payload results in `idempotency_conflict`.
- Stripe requests include idempotency keys mirroring booking action key to avoid duplicate captures.

---

**Phase 0 Summary**: The current codebase establishes the Next.js 14 App Router scaffold with Tailwind, shadcn-ready utilities, Lucide icons, Framer Motion, and React Compiler. The landing page mirrors the specified hero design, providing CTA pathways for future onboarding. No backend exists yet; this spec enumerates the intended system so API/database development can align with the planned UX and flows.

